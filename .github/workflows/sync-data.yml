name: åŒæ­¥è³‡æ–™

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  schedule:
    - cron: '0 */6 * * *'  # æ¯ 6 å°æ™‚åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: ç”¢ç”Ÿ issues.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // å–å¾—æ‰€æœ‰ Issues
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            // éæ¿¾æ‰ PRï¼ˆGitHub æœƒæŠŠ PR ä¹Ÿç•¶æˆ Issueï¼‰
            const realIssues = issues.filter(issue => !issue.pull_request);
            
            // è§£æ Issue è³‡æ–™
            const parsedIssues = realIssues.map(issue => {
              const body = issue.body || '';
              const labels = issue.labels.map(l => l.name);
              
              // æå–ç¸£å¸‚
              let city = '';
              const cityLabel = labels.find(l => l.startsWith('ç¸£å¸‚/'));
              if (cityLabel) {
                city = cityLabel.replace('ç¸£å¸‚/', '');
              }
              
              // æå–å•é¡Œé¡å‹
              let type = '';
              const typeLabel = labels.find(l => l.startsWith('é¡å‹/'));
              if (typeLabel) {
                type = typeLabel.replace('é¡å‹/', '');
              }
              
              // æå–ç‹€æ…‹
              let status = 'å¾…ç¢ºèª';
              const statusLabel = labels.find(l => l.startsWith('ç‹€æ…‹/'));
              if (statusLabel) {
                status = statusLabel.replace('ç‹€æ…‹/', '');
              }
              
              // æå–åœ°é»ï¼ˆå¾ Issue body è§£æï¼‰
              let location = '';
              const locationMatch = body.match(/ğŸ“ åœ°é»\s*\n\s*(.+)/);
              if (locationMatch) {
                location = locationMatch[1].trim();
              }
              
              return {
                id: issue.number,
                title: issue.title,
                url: issue.html_url,
                location: location,
                city: city,
                type: type,
                status: status,
                labels: labels,
                createdAt: issue.created_at,
                updatedAt: issue.updated_at,
                closedAt: issue.closed_at
              };
            });
            
            // è¨ˆç®—çµ±è¨ˆ
            const stats = {
              total: parsedIssues.length,
              byStatus: {},
              byCity: {},
              byType: {}
            };
            
            parsedIssues.forEach(issue => {
              // ç‹€æ…‹çµ±è¨ˆ
              stats.byStatus[issue.status] = (stats.byStatus[issue.status] || 0) + 1;
              
              // ç¸£å¸‚çµ±è¨ˆ
              if (issue.city) {
                stats.byCity[issue.city] = (stats.byCity[issue.city] || 0) + 1;
              }
              
              // é¡å‹çµ±è¨ˆ
              if (issue.type) {
                stats.byType[issue.type] = (stats.byType[issue.type] || 0) + 1;
              }
            });
            
            // çµ„åˆæœ€çµ‚è³‡æ–™
            const data = {
              lastUpdated: new Date().toISOString(),
              stats: stats,
              issues: parsedIssues
            };
            
            // å¯«å…¥æª”æ¡ˆ
            fs.writeFileSync('data/issues.json', JSON.stringify(data, null, 2));
            console.log(`Generated issues.json with ${parsedIssues.length} issues`);
      
      - name: Commit è®Šæ›´
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/issues.json
          git diff --staged --quiet || git commit -m "chore: æ›´æ–° issues.json [skip ci]"
          git push
